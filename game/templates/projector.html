<!-- Save this as game/templates/projector.html -->
{% extends "base.html" %}

{% block title %}Wedding Trivia - Projector Display{% endblock %}

{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }
    
    .projector-container {
        max-width: 100vw;
        height: 100vh;
        padding: 2vh 2vw;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-sizing: border-box;
    }
    
    .projector-title {
        font-size: clamp(2em, 6vw, 4em);
        margin-bottom: clamp(20px, 3vh, 40px);
        text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        color: white;
        flex-shrink: 0;
    }
    
    .projector-question {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        border-radius: 30px;
        padding: clamp(20px, 4vh, 60px) clamp(20px, 3vw, 60px);
        margin: clamp(10px, 2vh, 20px) 0;
        height: auto;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        overflow-y: auto;
        flex: 1;
    }
    
    .projector-category {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        padding: clamp(10px, 2vh, 20px) clamp(20px, 3vw, 40px);
        border-radius: 25px;
        font-size: clamp(1em, 3vw, 1.8em);
        display: inline-block;
        margin-bottom: clamp(20px, 3vh, 40px);
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
        flex-shrink: 0;
    }
    
    .projector-question-text {
        font-size: 2em !important;
        font-weight: bold;
        color: #333;
        margin: clamp(20px, 3vh, 40px) 0;
        line-height: 1.2;
        flex-shrink: 1;
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    .projector-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: clamp(15px, 2vw, 30px);
        margin: clamp(25px, 4vh, 50px) 0;
        max-width: 90vw;
        margin-left: auto;
        margin-right: auto;
        flex-shrink: 0;
    }
    
    .projector-option {
        background: #f8f9fa;
        border: 4px solid #dee2e6;
        padding: clamp(15px, 3vh, 40px) clamp(10px, 2vw, 20px);
        border-radius: 20px;
        font-size: clamp(1em, 2.5vw, 1.8em);
        font-weight: bold;
        color: #333;
        transition: all 0.5s ease;
        min-height: clamp(60px, 8vh, 120px);
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        overflow-wrap: break-word;
        word-wrap: break-word;
        hyphens: auto;
    }
    
    .projector-option.correct {
        background: #28a745;
        color: white;
        border-color: #28a745;
        animation: pulse 2s infinite;
        transform: scale(1.05);
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .projector-timer {
        font-size: clamp(3em, 8vw, 6em);
        font-weight: bold;
        color: #ff6b6b;
        margin: clamp(15px, 2vh, 30px) 0;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        font-family: 'Courier New', monospace;
        flex-shrink: 0;
    }
    
    .projector-timer.warning {
        color: #ff0000;
        animation: blink 1s infinite;
    }
    
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }
    
    .projector-status {
        font-size: 0.5em;
        margin: 40px 0;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .projector-waiting {
        background-color: rgba(255, 255, 255, 0.95);
        color: #333 !important;
        border-radius: 30px;
        padding: 80px;
        margin: 40px 0;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    .projector-scores {
        background-color: rgba(255, 255, 255, 0.95);
        color: #333 !important;
        border-radius: 30px;
        padding: 60px;
        margin: 20px 0;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        justify-content: center;
        width: 90%;
        min-height: 500px;
    }
    
    .projector-scores-table {
        width: 100%;
        border-collapse: collapse;
        margin: 30px 0;
        font-size: 1.8em;
    }
    
    .projector-scores-table th,
    .projector-scores-table td {
        padding: 20px;
        text-align: left;
        border-bottom: 3px solid #dee2e6;
    }
    
    .projector-scores-table th {
        background: #667eea;
        color: white;
        font-weight: bold;
        font-size: 1.2em;
    }
    
    .projector-scores-table tbody tr:first-child {
        background: rgba(255, 215, 0, 0.5);
        font-weight: bold;
        font-size: 1.2em;
    }
    
    .answer-reveal {
        background: #28a745;
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin: 30px 0;
        font-size: 1em;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    @media (max-width: 1200px) {
        .projector-options {
            /* grid-template-columns: 1fr; */
            gap: clamp(10px, 2vh, 20px);
        }
        
        .projector-option {
            min-height: clamp(50px, 6vh, 80px);
        }
    }
    
    @media (max-height: 600px) {
        .projector-container {
            padding: 1vh 2vw;
        }
        
        .projector-question {
            padding: clamp(10px, 2vh, 30px) clamp(15px, 2vw, 40px);
            max-height: 85vh;
        }
        
        .projector-question-text {
            font-size: 1.5em;
            margin: clamp(10px, 2vh, 20px) 0;
        }
        
        .projector-timer {
            font-size: clamp(2em, 6vw, 4em);
            margin: clamp(10px, 1vh, 15px) 0;
        }
    }
</style>

<div class="projector-container">

    
    <div id="waitingDisplay" class="projector-waiting">
        <h2 style="font-size: 3em; margin-bottom: 30px; color: #333 !important">‚è≥ Waiting for next question...</h2>
        <p style="font-size: 2em;">Teams registered: <span id="teamsCount">0</span></p>
        <p style="font-size: 1.5em; margin-top: 30px; opacity: 0.8;">Admin: Start the next question to begin!</p>
    </div>
    
    <div id="questionDisplay" style="display: none;">
        <div class="projector-question">
            <div class="projector-category" id="questionCategory"></div>
            <div class="projector-question-text" id="questionText"></div>
            <div class="projector-timer" id="timer">30</div>
            <div class="projector-options" id="optionsContainer"></div>
        </div>
    </div>
    
    <div id="intermissionDisplay" style="display: none;">
        <div class="projector-question">
            <div class="projector-category" id="intermissionCategory"></div>
            <div class="projector-question-text" id="intermissionQuestion"></div>
            <div class="answer-reveal" id="answerReveal"></div>
            <div class="projector-options" id="intermissionOptions"></div>
            <div class="projector-status">
                <div class="projector-timer" id="intermissionTimer">30</div>
                <p>Next question starting in...</p>
            </div>
        </div>
    </div>
    
    <div id="scoresDisplay" style="display: none;">
        <div class="projector-scores">
            <h2 style="font-size: 2.0em; margin-bottom: 40px; color: #333 !important">üìä Current Leaderboard</h2>
            <div id="projectorAnswerReveal" class="answer-reveal" style="margin-bottom: 40px;"></div>
            <canvas id="projectorScoresChart" width="1000" height="600" style="background: white; border-radius: 20px; margin: 20px 0;"></canvas>
            <!-- <div class="projector-status">
                <p style="font-size: 2em; color: #333 !important;">üéØ Get ready for the next question!</p>
            </div> -->
        </div>
    </div>
    
    <div id="resultsDisplay" style="display: none;">
        <div class="projector-scores">
            <h2 style="font-size: 3.5em; margin-bottom: 40px;">üèÜ Final Results</h2>
            <table class="projector-scores-table" id="finalScores">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Team</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let projectorInterval = setInterval(updateProjectorDisplay, 1000);

function updateProjectorDisplay() {
    fetch('/game/api/game_status')
    .then(response => response.json())
    .then(data => {
        document.getElementById('teamsCount').textContent = data.teams_count;
        
        if (data.in_intermission) {
            showProjectorIntermission(data.question, data.intermission_time);
        } else if (data.show_answer && data.question) {
            showProjectorScores(data.current_scores, data.question);
        } else if (data.game_active && data.question) {
            showProjectorQuestion(data.question, data.time_remaining, data.show_answer);
        } else if (data.current_question >= data.total_questions) {
            showProjectorResults();
        } else {
            showProjectorWaiting();
        }
    })
    .catch(error => console.error('Error updating projector:', error));
}

function showProjectorWaiting() {
    document.getElementById('waitingDisplay').style.display = 'block';
    document.getElementById('questionDisplay').style.display = 'none';
    document.getElementById('intermissionDisplay').style.display = 'none';
    document.getElementById('scoresDisplay').style.display = 'none';
    document.getElementById('resultsDisplay').style.display = 'none';
}

function showProjectorScores(scores, lastQuestion) {
    document.getElementById('waitingDisplay').style.display = 'none';
    document.getElementById('questionDisplay').style.display = 'none';
    document.getElementById('intermissionDisplay').style.display = 'none';
    document.getElementById('scoresDisplay').style.display = 'block';
    document.getElementById('resultsDisplay').style.display = 'none';
    
    // Show correct answer
    if (lastQuestion) {
        const correctAnswer = lastQuestion.options[lastQuestion.correct];
        document.getElementById('projectorAnswerReveal').textContent = 
            `Correct Answer: ${String.fromCharCode(65 + lastQuestion.correct)}. ${correctAnswer} (${lastQuestion.points} points)`;
    }
    
    // Draw the big chart
    drawProjectorScoresChart(scores);
}

function drawProjectorScoresChart(scores) {
    const canvas = document.getElementById('projectorScoresChart');
    const ctx = canvas.getContext('2d');
    
    // Set fixed canvas size - using full width for better visibility
    canvas.width = 1200;
    canvas.height = 500;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (scores.length === 0) {
        ctx.font = 'bold 32px Arial';
        ctx.fillStyle = '#333';
        ctx.textAlign = 'center';
        ctx.fillText('No scores yet!', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Enhanced chart settings for projector visibility
    const padding = 40;
    const chartWidth = canvas.width - (padding * 2);
    const chartHeight = canvas.height - (padding * 2);
    const barHeight = Math.min(45, chartHeight / Math.min(scores.length, 8) - 8);
    const maxScore = Math.max(...scores.map(s => s[1]), 1);
    
    // Bright colors for better projector visibility
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF'];
    
    // Show top 8 teams
    const topScores = scores.slice(0, 8);
    
    topScores.forEach((score, index) => {
        const teamName = score[0];
        const teamScore = score[1];
        const barWidth = Math.max(80, (teamScore / maxScore) * chartWidth * 0.65);
        
        const x = padding + 50; // More space for rank numbers
        const y = padding + (index * (barHeight + 10));
        
        // Draw bar background with thicker border
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(x, y, chartWidth * 0.65, barHeight);
        ctx.strokeStyle = '#ddd';
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, chartWidth * 0.65, barHeight);
        
        // Draw colored bar with gradient
        const color = colors[index] || '#667eea';
        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, adjustBrightness(color, -20));
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Add larger rank number
        ctx.fillStyle = '#333';
        ctx.font = 'bold 22px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(index + 1, x - 25, y + barHeight/2 + 8);
        
        // Draw team name - much larger font
        ctx.fillStyle = '#333';
        ctx.font = 'bold 20px Arial';
        ctx.textAlign = 'left';
        const displayName = teamName.length > 18 ? teamName.substring(0, 18) + '...' : teamName;
        ctx.fillText(displayName, x + 10, y + barHeight/2 + 7);
        
        // Draw score - much larger font
        ctx.fillStyle = '#333';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(teamScore + ' pts', x + chartWidth * 0.7, y + barHeight/2 + 8);
        
        // Add larger medal emoji for top 3
        ctx.font = '24px Arial';
        if (index === 0) {
            ctx.fillText('üëë', x + chartWidth * 0.85, y + barHeight/2 + 8);
        } else if (index === 1) {
            ctx.fillText('ü•à', x + chartWidth * 0.85, y + barHeight/2 + 8);
        } else if (index === 2) {
            ctx.fillText('ü•â', x + chartWidth * 0.85, y + barHeight/2 + 8);
        }
    });
    
    // Add title at the top
    ctx.fillStyle = '#333';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('LEADERBOARD', canvas.width / 2, 35);
}

// Helper function to adjust color brightness
function adjustBrightness(color, amount) {
    const usePound = color[0] === '#';
    const col = usePound ? color.slice(1) : color;
    const num = parseInt(col, 16);
    let r = (num >> 16) + amount;
    let g = (num >> 8 & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;
    r = r > 255 ? 255 : r < 0 ? 0 : r;
    g = g > 255 ? 255 : g < 0 ? 0 : g;
    b = b > 255 ? 255 : b < 0 ? 0 : b;
    return (usePound ? '#' : '') + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
}

function showProjectorQuestion(question, timeRemaining, showAnswer) {
    document.getElementById('waitingDisplay').style.display = 'none';
    document.getElementById('questionDisplay').style.display = 'block';
    document.getElementById('intermissionDisplay').style.display = 'none';
    document.getElementById('scoresDisplay').style.display = 'none';
    document.getElementById('resultsDisplay').style.display = 'none';
    
    document.getElementById('questionCategory').textContent = question.category;
    document.getElementById('questionText').textContent = question.question;
    
    const timer = document.getElementById('timer');
    const timeLeft = Math.ceil(timeRemaining);
    timer.textContent = timeLeft;
    
    // Add warning animation when time is low
    if (timeLeft <= 10) {
        timer.classList.add('warning');
    } else {
        timer.classList.remove('warning');
    }
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'projector-option';
        optionDiv.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
        
        // Show correct answer if revealed
        if (showAnswer && question.correct !== undefined && index === question.correct) {
            optionDiv.classList.add('correct');
        }
        
        optionsContainer.appendChild(optionDiv);
    });
}

function showProjectorIntermission(question, timeRemaining) {
    document.getElementById('waitingDisplay').style.display = 'none';
    document.getElementById('questionDisplay').style.display = 'none';
    document.getElementById('intermissionDisplay').style.display = 'block';
    document.getElementById('scoresDisplay').style.display = 'none';
    document.getElementById('resultsDisplay').style.display = 'none';
    
    document.getElementById('intermissionCategory').textContent = question.category;
    document.getElementById('intermissionQuestion').textContent = question.question;
    document.getElementById('intermissionTimer').textContent = Math.ceil(timeRemaining);
    
    const optionsContainer = document.getElementById('intermissionOptions');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'projector-option';
        optionDiv.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
        
        if (index === question.correct) {
            optionDiv.classList.add('correct');
        }
        
        optionsContainer.appendChild(optionDiv);
    });
    
    document.getElementById('answerReveal').textContent = 
        `Correct Answer: ${String.fromCharCode(65 + question.correct)}. ${question.options[question.correct]} (${question.points} points)`;
}

function showProjectorResults() {
    document.getElementById('waitingDisplay').style.display = 'none';
    document.getElementById('questionDisplay').style.display = 'none';
    document.getElementById('intermissionDisplay').style.display = 'none';
    document.getElementById('scoresDisplay').style.display = 'none';
    document.getElementById('resultsDisplay').style.display = 'block';
    
    fetch('/game/api/scores')
    .then(response => response.json())
    .then(data => {
        const tbody = document.querySelector('#finalScores tbody');
        tbody.innerHTML = '';
        
        data.scores.forEach((score, index) => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = index + 1;
            row.insertCell(1).textContent = score[0];
            row.insertCell(2).textContent = score[1];
        });
    });
}
</script>
{% endblock %}