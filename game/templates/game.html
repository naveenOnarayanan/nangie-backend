{% extends "base.html" %}

{% block title %}Wedding Trivia - Team Game{% endblock %}

{% block content %}
<div class="card">
    <h1>üéØ Wedding Trivia Game</h1>
    
    <div id="registration" style="display: block;">
        <h2>Register Your Team</h2>
        <input type="text" id="teamName" placeholder="Enter your team name..." maxlength="50">
        <button class="btn" onclick="registerTeam()">Join Game!</button>
        <div id="regStatus"></div>
    </div>
    
    <div id="gameArea" style="display: none;">
        <div id="teamInfo" class="status info">
            <strong>Team: <span id="currentTeam"></span></strong>
        </div>
        
        <div id="waitingArea">
            <h2>‚è≥ Waiting for next question...</h2>
            <p>Teams registered: <span id="teamsCount">0</span></p>
        </div>
        
        <div id="intermissionArea" style="display: none;">
            <h2>üìä Answer Revealed!</h2>
            <div class="question-card">
                <div class="category" id="intermissionCategory"></div>
                <h3 id="intermissionQuestion" style="color: #333; margin: 15px 0;"></h3>
                <div class="options" id="intermissionOptions"></div>
                <div class="status success" id="answerReveal"></div>
            </div>
            <div class="timer" id="intermissionTimer">30</div>
            <p style="text-align: center; color: #333;">Next question starting in...</p>
        </div>
        
        <div id="questionArea" style="display: none;">
            <div class="question-card">
                <div class="category" id="questionCategory"></div>
                <h2 id="questionText" style="color: #333; margin: 15px 0; font-size: 1.4em;"></h2>
                <div class="timer" id="timer">30</div>
                <div class="options" id="optionsContainer"></div>
                <button class="btn" id="submitBtn" onclick="submitAnswer()" disabled>Submit Answer</button>
                <div id="submitMessage" style="display: none; text-align: center; margin-top: 10px; color: #333;"></div>
            </div>
        </div>
        
        <div id="resultsArea" style="display: none;">
            <h2>üèÜ Final Results</h2>
            <table class="scores-table" id="finalScores">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Team</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="gameStatus"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
let gameData = {
    teamName: '',
    selectedAnswer: null,
    gameInterval: null,
    hasSubmitted: false,
    lastQuestionText: ''
};

function registerTeam() {
    const teamName = document.getElementById('teamName').value.trim();
    if (!teamName) {
        showStatus('regStatus', 'Please enter a team name!', 'error');
        return;
    }
    
    fetch('/game/api/register_team', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({team_name: teamName})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            gameData.teamName = teamName;
            document.getElementById('currentTeam').textContent = teamName;
            document.getElementById('registration').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            startGamePolling();
            showStatus('gameStatus', 'Successfully registered! Wait for the game to start...', 'success');
        } else {
            showStatus('regStatus', data.message, 'error');
        }
    })
    .catch(error => {
        showStatus('regStatus', 'Error registering team', 'error');
    });
}

function startGamePolling() {
    gameData.gameInterval = setInterval(updateGameStatus, 1000);
    updateGameStatus();
}

function updateGameStatus() {
    fetch('/game/api/game_status')
    .then(response => response.json())
    .then(data => {
        document.getElementById('teamsCount').textContent = data.teams_count;
        
        if (data.in_intermission) {
            showIntermission(data.question, data.intermission_time);
        } else if (data.game_active && data.question) {
            showQuestion(data.question, data.time_remaining, data.show_answer);
        } else if (data.current_question >= data.total_questions) {
            showResults();
        } else {
            showWaiting();
        }
    })
    .catch(error => console.error('Error updating game status:', error));
}

function showWaiting() {
    document.getElementById('waitingArea').style.display = 'block';
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('intermissionArea').style.display = 'none';
    document.getElementById('resultsArea').style.display = 'none';
}

function showIntermission(question, timeRemaining) {
    document.getElementById('waitingArea').style.display = 'none';
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('intermissionArea').style.display = 'block';
    document.getElementById('resultsArea').style.display = 'none';
    
    document.getElementById('intermissionCategory').textContent = question.category;
    document.getElementById('intermissionQuestion').textContent = question.question;
    document.getElementById('intermissionTimer').textContent = Math.ceil(timeRemaining);
    
    const optionsContainer = document.getElementById('intermissionOptions');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option';
        optionDiv.style.color = '#333';
        optionDiv.style.fontSize = '16px';
        
        if (index === question.correct) {
            optionDiv.className += ' selected';
            optionDiv.style.background = '#28a745';
            optionDiv.style.color = 'white';
            optionDiv.style.fontWeight = 'bold';
        }
        optionDiv.textContent = option;
        optionsContainer.appendChild(optionDiv);
    });
    
    document.getElementById('answerReveal').textContent = 
        `Correct answer: ${question.options[question.correct]} (${question.points} points)`;
}

function showQuestion(question, timeRemaining, showAnswer) {
    document.getElementById('waitingArea').style.display = 'none';
    document.getElementById('questionArea').style.display = 'block';
    document.getElementById('intermissionArea').style.display = 'none';
    document.getElementById('resultsArea').style.display = 'none';
    
    document.getElementById('questionCategory').textContent = question.category;
    document.getElementById('questionText').textContent = question.question;
    document.getElementById('timer').textContent = Math.ceil(timeRemaining);
    
    const optionsContainer = document.getElementById('optionsContainer');
    
    // Check if this is a new question by comparing question text
    const currentQuestionText = document.getElementById('questionText').textContent;
    const isNewQuestion = !gameData.lastQuestionText || gameData.lastQuestionText !== question.question;
    
    if (isNewQuestion) {
        // Reset state for new question
        gameData.hasSubmitted = false;
        gameData.selectedAnswer = null;
        gameData.lastQuestionText = question.question;
        
        // Rebuild options for new question
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, index) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option';
            optionDiv.style.color = '#333';
            optionDiv.style.fontSize = '16px';
            optionDiv.style.cursor = 'pointer';
            optionDiv.textContent = option;
            
            // Only allow selection if answers aren't locked and answer isn't shown
            if (!showAnswer && timeRemaining > 0) {
                optionDiv.onclick = () => selectOption(index, optionDiv);
            }
            
            optionsContainer.appendChild(optionDiv);
        });
    } else {
        // Update existing options for answer reveal or time changes
        const options = optionsContainer.children;
        for (let i = 0; i < options.length; i++) {
            const optionDiv = options[i];
            
            // Show correct answer if answer is revealed
            if (showAnswer && question.correct !== undefined && i === question.correct) {
                optionDiv.style.background = '#28a745';
                optionDiv.style.color = 'white';
                optionDiv.style.fontWeight = 'bold';
            }
            
            // Remove click handlers if time is up or answer is shown
            if (showAnswer || timeRemaining <= 0) {
                optionDiv.onclick = null;
                optionDiv.style.cursor = 'default';
            }
        }
    }
    
    // Update submit button state
    const submitBtn = document.getElementById('submitBtn');
    const submitMessage = document.getElementById('submitMessage');
    
    if (showAnswer || timeRemaining <= 0) {
        submitBtn.style.display = 'none';
        submitMessage.style.display = 'none';
    } else if (gameData.hasSubmitted) {
        submitBtn.style.display = 'none';
        submitMessage.style.display = 'block';
        submitMessage.textContent = '‚úì Answer submitted! Wait for results...';
        submitMessage.style.color = '#28a745';
        submitMessage.style.fontWeight = 'bold';
    } else {
        submitBtn.style.display = 'block';
        submitMessage.style.display = 'none';
        submitBtn.disabled = gameData.selectedAnswer === null;
    }
}

function selectOption(index, element) {
    // Don't allow selection if already submitted
    if (gameData.hasSubmitted) {
        console.log('Already submitted, ignoring click');
        return;
    }
    
    console.log('Selecting option:', index); // Debug log
    
    // Remove previous selection
    document.querySelectorAll('#optionsContainer .option').forEach(opt => {
        opt.classList.remove('selected');
        opt.style.background = '#f8f9fa';
        opt.style.color = '#333';
        opt.style.borderColor = '#dee2e6';
    });
    
    // Add selection to clicked option
    element.classList.add('selected');
    element.style.background = '#667eea';
    element.style.color = 'white';
    element.style.borderColor = '#667eea';
    
    gameData.selectedAnswer = index;
    document.getElementById('submitBtn').disabled = false;
    
    console.log('Selected answer:', gameData.selectedAnswer, 'hasSubmitted:', gameData.hasSubmitted);
}

function submitAnswer() {
    if (gameData.selectedAnswer === null || gameData.hasSubmitted) return;
    
    fetch('/game/api/submit_answer', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            team_name: gameData.teamName,
            answer: gameData.selectedAnswer
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            gameData.hasSubmitted = true;
            
            // Lock all options - remove click handlers and change cursor
            document.querySelectorAll('#optionsContainer .option').forEach(opt => {
                opt.onclick = null;
                opt.style.cursor = 'default';
                opt.style.opacity = '0.7';
            });
            
            // Update button and show message
            document.getElementById('submitBtn').style.display = 'none';
            const submitMessage = document.getElementById('submitMessage');
            submitMessage.style.display = 'block';
            submitMessage.textContent = '‚úì Answer submitted! Wait for results...';
            submitMessage.style.color = '#28a745';
            submitMessage.style.fontWeight = 'bold';
            
            showStatus('gameStatus', 'Answer submitted successfully!', 'success');
        } else {
            showStatus('gameStatus', data.message, 'error');
        }
    })
    .catch(error => {
        showStatus('gameStatus', 'Error submitting answer', 'error');
    });
}

function showResults() {
    clearInterval(gameData.gameInterval);
    document.getElementById('waitingArea').style.display = 'none';
    document.getElementById('questionArea').style.display = 'none';
    document.getElementById('intermissionArea').style.display = 'none';
    document.getElementById('resultsArea').style.display = 'block';
    
    fetch('/game/api/scores')
    .then(response => response.json())
    .then(data => {
        const tbody = document.querySelector('#finalScores tbody');
        tbody.innerHTML = '';
        
        data.scores.forEach((score, index) => {
            const row = tbody.insertRow();
            row.insertCell(0).textContent = index + 1;
            row.insertCell(1).textContent = score[0];
            row.insertCell(2).textContent = score[1];
            
            if (index === 0) {
                row.style.background = 'rgba(255, 215, 0, 0.3)'; // Gold for winner
            }
        });
    });
}

function showStatus(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.innerHTML = message;
    element.className = `status ${type}`;
    element.style.display = 'block';
}
{% endblock %}